<html>
<head>
<script src="webcl.js" ></script>
<script id="clProgramVectorAdd" type="text/x-opencl">
  kernel void ckVectorAdd(global uint* vectorIn1, 
                          global uint* vectorIn2,
                          global uint* vectorOut,
                          uint uiVectorWidth) {
     uint x = get_global_id(0);
     if (x >= uiVectorWidth)
     {
       return;
    }
    // add the vector elements
    vectorOut[x] = vectorIn1[x] + vectorIn2[x];
  }
</script> 

<script id="clProgramDesaturate" type="text/x-opencl">
  kernel void clDesaturate(global const uchar4* src,
                           global uchar4* dst,
                           uint width, 
                           uint height)
  {
    int x = get_global_id(0);
    int y = get_global_id(1);
    if (x >= width || y >= height) return;

    int i = y * width + x;

    uchar4 color = src[i];
    uchar lum = (uchar)(0.30f * color.x + 0.59f * color.y + 0.11f * color.z);
    dst[i] = (uchar4)(lum, lum, lum, 255);
  }
</script> 

<script id="clProgramEmboss" type="text/x-opencl">
  kernel void clEmboss(global const uchar4* src,
                           global uchar4* dst,
                           uint width, 
                           uint height)
  {
    int x = get_global_id(0);
    int y = get_global_id(1);
    if (x >= width || y >= height) return;

	int x1 = x + 1;
	int y1 = y + 1;
	
	if(x1 >= width) x1 = 0;
	if(y1 >= height) y1 = 0;
	
    int i = y * width + x;
	int j = y1 * width + x1;
	
	float3 color1 = (1.0f/255) * convert_float3(src[i].xyz);
	float3 color2 = (1.0f/255) * convert_float3(src[j].xyz);

	float3 diffs = color1 - color2;
	float max = diffs.x;
	if(fabs(diffs.y) > fabs(max)) max = diffs.y;
	if(fabs(diffs.z) > fabs(max)) max = diffs.z;
	
	float gray = clamp(max + .5, 0., 1.);
	float3 grayVersion = (gray, gray, gray);
	float3 colorVersion = (gray*color1);
	
	float3 inter = mix(grayVersion, colorVersion, 0);

	dst[i] = (uchar4)((uchar)(inter.x * 255.99f), (uchar)(inter.y * 255.99f), (uchar)(inter.z * 255.99f), 255);
	
  }
</script> 

<script id="clProgramEdge" type="text/x-opencl">
  kernel void clEdge(global const uchar4* src,
                           global uchar4* dst,
                           uint width, 
                           uint height)
  {
  
	const float3 LUMCOEFFS = (0.2125, 0.7154, 0.0721);
  
    int x = get_global_id(0);
    int y = get_global_id(1);
    if (x >= width || y >= height) return;

	int x1 = x + 1;
	int y1 = y + 1;
	
	if(x1 >= width) x1 = 0;
	if(y1 >= height) y1 = 0;
	
	int x2 = x - 1;
	int y2 = y - 1;
	
	if(x2 >= width) x2 = 0;
	if(y2 >= height) y2 = 0;
	
    int i1 = y * width + x;
	int i2 = y1 * width + x1;
	int i3 = y1 * width + x;
	int i4 = y * width + x1;
	int i5 = y * width + x2;
	int i6 = y2 * width + x;
	int i7 = y2 * width + x1;
	int i8 = y1 * width + x2;
	int i9 = y2 * width + x2;

	float3 rgb = (1.0f/255) * convert_float3(src[i1].xyz);
	
	float color1 = dot((1.0f/255) * convert_float3(src[i1].xyz), LUMCOEFFS);
	float color2 = dot((1.0f/255) * convert_float3(src[i2].xyz), LUMCOEFFS);
	float color3 = dot((1.0f/255) * convert_float3(src[i3].xyz), LUMCOEFFS);
	float color4 = dot((1.0f/255) * convert_float3(src[i4].xyz), LUMCOEFFS);
	float color5 = dot((1.0f/255) * convert_float3(src[i5].xyz), LUMCOEFFS);
	float color6 = dot((1.0f/255) * convert_float3(src[i6].xyz), LUMCOEFFS);
	float color7 = dot((1.0f/255) * convert_float3(src[i7].xyz), LUMCOEFFS);
	float color8 = dot((1.0f/255) * convert_float3(src[i8].xyz), LUMCOEFFS);
	float color9 = dot((1.0f/255) * convert_float3(src[i9].xyz), LUMCOEFFS);

	
	float h = -1. * color8 - 2. * color3 - 1. * color2 + 1. * color9 + 2. * color6 + 1. * color7;
	float v = -1. * color9 - 2. * color5 - 1. * color8 + 1. * color7 + 2. * color4 + 1. * color2;
	
	float mag  = sqrt(h*h + v*v);
	float3 target = (mag, mag, mag);
	float3 inter = mix(rgb, target, 1);


	dst[i1] = (uchar4)((uchar)(inter.x * 255.99f), (uchar)(inter.y * 255.99f), (uchar)(inter.z * 255.99f), 255);
	
  }
</script> 



</head>
<body onload="vectorAdd()">


<img id="srcimg" onload="setupCanvas();" style="display:none;"src="img.png"></img>
<canvas id="canvasImg" height="512" width="512"></canvas>
<p></p>
<button id="button" type="button" value="Process" onclick="desaturate();">Button
</button>
<div id="output">
</div>

</body>
</html>