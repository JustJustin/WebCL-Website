<script src="/js/tutorials/tutorial_resources/sylvester.js" type="text/javascript"></script>
<script src="/js/tutorials/tutorial_resources/glUtils.js" type="text/javascript"></script>
<script src="tut3.js"></script>
<script src="sylvester.js" type="text/javascript"></script>
<script src="glUtils.js" type="text/javascript"></script>


<canvas id="glcanvas" class="webglSide">
Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
</canvas>

<script type="text/javascript">
function resizeCanvasHandler(el) {
    var canvas = document.getElementById("glcanvas");
    canvas.getContext("webgl").viewport(0, 0, $(canvas).width(), $(canvas).height());
    console.log("resizeCanvasHandler", $(canvas).width(), $(canvas).height());
}
function setCanvasSize() {
    var canvas = document.getElementById("glcanvas");
    var holder = $(canvas).parents("div.outputContainer");
    
    if( canvas.expanded ) { 
        return; 
    }
    
    var width = holder.width() - 3;
    var height = Math.floor( width / (16/9) );
    
    //Change to run only when it needs to.
    
    canvas.width = width;
    canvas.height = height;
}
setCanvasSize();

var canvas = document.getElementById("glcanvas");
var holder = $(canvas).parents("div.outputContainer").first();

if( !window.ourresize ) {
    window.ourresize = true;
    $(window).resize(setCanvasSize);
}

holder.resize(setCanvasSize);
$(canvas).resize(resizeCanvasHandler);
</script>


<script id="shader-fs" type="x-shader/x-fragment">
	varying lowp vec4 vColor;
	
  void main(void) {
	gl_FragColor = vColor;
  }
</script>

<script id="shader-vs" type="x-shader/x-vertex">
  attribute vec4 aVertexPosition;
  attribute vec4 aVertexColor;

  uniform mat4 uMVMatrix;
  uniform mat4 uPMatrix;
  
  varying lowp vec4 vColor;

  void main(void) {
	gl_Position = uPMatrix * uMVMatrix * aVertexPosition;
	gl_PointSize = 1.;
	vColor = aVertexColor;
  }
</script>

<script id="clKernel">
	typedef float4 point;
	typedef float4 vector;
	typedef float4 color;
	typedef float4 sphere;
	
	
	constant float4 G       = (float4) ( 0., -9.8, 0., 0. );
	constant float  DT      = 0.1;
	constant sphere Sphere1 = (sphere)( -100., -800., 0.,  600. );
	
	vector
	Bounce( vector in, vector n )
	{
		n.w = 0.;
		n = normalize( n );
		vector out = in - 2.0f * dot(in.xyz, n.xyz) * n;
		out.w = 0.;
		return out;
	}

	vector
	BounceSphere( point p, vector v, sphere s )
	{
		return Bounce(v, (float4)( p.x, p.y, p.z, 0 ) - (float4)( s.x, s.y, s.z, 0 ));
	}

	bool
	IsInsideSphere( point p, sphere s )
	{
		if(s.w >= fast_distance( (float3)( p.x, p.y, p.z ), (float3)( s.x, s.y, s.z )))
			return true;
		else
			return false;
	}
	
	vector
	GravitySphere (point p, float m1, sphere s, float m2)
	{
		float r = fast_distance( (float3)( p.x, p.y, p.z ), (float3)( s.x, s.y, s.z ));
		vector d = p - s;
		float co = 6.67E-11 * r * m1 * m2;
		d = -co *  d;
		d.w = 1;
		return d;
	}
	
	
	kernel void Particle (global point *dPobj, global vector *dVobj, global color *dCobj) {
	
	
		int gid = get_global_id( 0 );
	
		point  p = dPobj[gid];
		vector v = dVobj[gid];
		color  c = dCobj[gid];
		
		//vector force = GravitySphere(p, .000005, Sphere1, 5000.0);
		
		vector a = G;
		//vector a = (1/.000005f) * force;
		
		point pp = p + DT * v + .5f * DT * DT * a;
		vector vp = v + DT * a;
		
		pp.w = 1.;
		vp.w = 0.;
		
		
		if( IsInsideSphere( pp, Sphere1 ) )
		{
			vp = BounceSphere( p, v, Sphere1 );
			pp = p + DT * vp + .5f*DT*DT*a;
		}
		
		dPobj[gid] = pp;
		dVobj[gid] = vp;
		dCobj[gid] = c;
	}
	
	
	
</script>

<button id="runButton" >Run Program</button>
<button id="expandButton">Expand</button>

<script style="text/javascript">
var el = document.getElementById("expandButton");
var canvas = document.getElementById("glcanvas");

canvas.expanded = false;

function resizeCanvas() {
    if( canvas.expanded ) {
        canvas.expanded = false;
        canvas.style.top = "";
        $(canvas).removeClass("bigCanvas");
        setCanvasSize();
    } else {
        canvas.expanded = true;
        canvas.style.top = Math.ceil($(canvas).position().top+1)+"px";
        $(canvas).addClass("bigCanvas");
        canvas.width=1366;
        canvas.height=768;
    }
    resizeCanvasHandler();
}

el.expanded = false;
$(el).click(function() {
    resizeCanvas();
    if( el.expanded ) {
        el.expanded = false;
        $(el).text("Expand");
    } else {
        el.expanded = true;
        $(el).text("Contract");
    }
});
</script>
